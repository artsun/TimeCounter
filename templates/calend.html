{% extends "base.html" %}


{% block show %}
<div class="row">
    {% if current_user.is_authenticated %}
    <div class="col-5">
        <div id="myCalendar" class="vanilla-calendar"></div>
    </div>
    <div class="col">
        Осталось сегодня
        <div id="MyClockDisplay" class="clock-dyn" onload="showTime()"></div>
        <br>
        {% if fin %}
        Начало {{fin.start.strftime('%H')}}:{{fin.start.strftime('%M')}}:{{fin.start.strftime('%S')}}
        | {{fin.start.day}} {{show_month}}
        <br>
        Финиш {{fin.stop.strftime('%H')}}:{{fin.stop.strftime('%M')}}:{{fin.stop.strftime('%S')}}
        | {{fin.stop.day}} {{show_month}}
        {%endif%}
        <br>
        <br>
        {% if breaks %}
        Перерывы:
        <br>
            {% for brk in breaks %}
            <tr>
                <td>{{brk.start.day}} {{show_month}}</td>
                <td>{{brk.start.strftime('%H')}}:{{brk.start.strftime('%M')}}:{{brk.start.strftime('%S')}} -
                    {% if brk.done %}
                    {{brk.stop.strftime('%H')}}:{{brk.stop.strftime('%M')}}:{{brk.stop.strftime('%S')}}
                    {{brk.duration}}
                    {% endif %}

                </td>
            </tr>
        <br>
            {% endfor %}
        {% endif %}
        {% if fin and fin.done%}
        <br>
            Продолжительность составила: {{fin.duration}}
            {% if breaks_sum %}
                <br>
                при этом, суммарно перерывов на: {{ breaks_sum }}
            {%endif%}
        {%endif%}


    </div>
    {%endif%}

    {% if not current_user.is_authenticated %}
    <div class="col-11">
        <a>Главная страница, Добро пожаловать!!!</a>
    </div>
    {%endif%}

    <div class="col-1">
    <!--clock start-->
        <div class="clock">
            <div class="hour">
                <div class="hr" id="hr">
                </div>
            </div>
            <div class="min">
                <div class="mn" id="mn">
                </div>
            </div>
            <div class="sec">
                <div class="sc" id="sc">
                </div>
            </div>
        </div>
    <!--clock end-->
    </div>
</div>

<link rel="stylesheet" href="/css/vis_clock.css" />
<script src="/js/vis_clock.js"></script>

<!---->

<link rel="stylesheet" href="/css/vanilla-calendar-min.css">
<script src="/js/vanilla-calendar-min.js"></script>

<script type="text/javascript">
async function send_selected_date(data, elem) {
	selected_date = new Date(data['date']);
    window.location.replace(`?day=${selected_date.getDate()}&month=${selected_date.getMonth()+1}&year=${selected_date.getFullYear()}`);
}
let TDD = new Date();
{% if fin %}
TDD.setDate({{fin.start.day}});
TDD.setMonth({{fin.start.month-1}});
TDD.setYear({{fin.start.year}});
{% endif %}

let myCalendar = new VanillaCalendar({
    selector: "#myCalendar",
    pastDates: 1,
    datesFilter: 0,
    onSelect: (data, elem) => { send_selected_date(data, elem) },
    date: new Date(),
    todaysDate: TDD,
    availableWeekDays: [
        //{day: 'monday', others: values},
    ],
    availableDates: [
        //{date: '2020-07-07', others: values},
    ],
    months: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
    shortWeekday: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']

})
</script>

{% endblock %}

{% block control %}
<div class="row">
    <div class="col-3">
        <form method="POST" action="/">
            <div class="input-group">
                <input type="number" class="form-control" id="begind" name="begind" placeholder="часов" min="1" max="16" value="{{begind}}">
                <button class="btn btn-outline-secondary">Старт</button>
            </div>
        </form>
    </div>
    <div class="col-3">
        <form method="POST" action="/">
            <div class="input-group">
                <button class="btn btn-outline-secondary" name="resetd" value="true">Сбросить</button>
            </div>
        </form>
    </div>
</div>
<div class="row mt-3 mb-3">
</div>
<div class="row">
    <div class="col-3">
        <form method="POST" action="/">
            <div class="input-group">
                <input type="number" class="form-control" id="changed" name="changed" placeholder="часов" min="0" max="16" value="0">
                <button class="btn btn-outline-secondary">Изменить</button>
            </div>
        </form>
    </div>
    <div class="col-3">
        <form method="POST" action="/">
            <div class="input-group">
                <button class="btn btn-outline-secondary" name="finishd" value="true">Завершить</button>
            </div>
        </form>
    </div>
    <div class="col-3">
        <form method="POST" action="/">
            <div class="input-group">
                <button class="btn btn-outline-secondary" name="paused" value="true">{{pause_label}}</button>
            </div>
        </form>
    </div>
</div>

<!--dyn clock-->
<script type="text/javascript">
    function calcShowTime(h, m, s){
        if (s > 0){
            s -= 1;
        } else {
            s = (m>0) ? 59 : 0;
            if (m>0){
                m -= 1;
            } else {
                m = (h>0) ? 59 : 0;
                s = (m>0) ? 59 : 0;
                h = (h>0) ? h-1: h;
            }
        }
        return (h, m, s)
    }

    let was_started = 1;
    let h = 0; // 0 - 23
    let m = 0; // 0 - 59
    let s = 0; // 0 - 59
    let is_pause = {{is_pause}};

    async function showTime(){
        if (was_started===1){
            let response = await fetch(`/refreshtimer?refreshLeftTime=true`);
            let resp = await response.json();
            h = resp['getHours'];
            m = resp['getMinutes'];
            s = resp['getSeconds'];
            was_started = 0;
        }

            h, m, s = calcShowTime(h, m, s);


    h_d = (h < 10) ? "0" + h : h;
    m_d = (m < 10) ? "0" + m : m;
    s_d = (s < 10) ? "0" + s : s;

    let time = h_d + ":" + m_d + ":" + s_d;
    document.getElementById("MyClockDisplay").innerText = time;
    document.getElementById("MyClockDisplay").textContent = time;

    if (is_pause!==1){
    setTimeout(showTime, 1000);
    }
}

showTime();
</script>
{% endblock %}
